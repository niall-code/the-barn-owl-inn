{% extends "base.html" %}
{% load static %}
{% block content %}

  {% if user.is_authenticated %}

    <h2>My Existing Reservations</h2>

    {% for reservation in reservations %}
      {% if reservation.reserver == user %}

        <div>

          <p id="date{{ reservation.id }}">{{ reservation.date|date:"Y-m-d" }}</p>
          <p id="time{{ reservation.id }}">{{ reservation.start_time|time:"H:i" }}</p>
          <p id="length{{ reservation.id }}">{{ reservation.duration }}</p>
          {% for table in reservation.tables.all %}
            <p class="table-for-{{ reservation.id }}">{{ table.number }}</p>
          {% endfor %}
          <p id="contact{{ reservation.id }}">{{ reservation.contact }}</p>

        </div>

        <button class="edit" data-reservation_id="{{ reservation.id }}">Edit</button>
        <button class="delete" data-reservation_id="{{ reservation.id }}">Delete</button>

      {% endif %}
    {% endfor %}

    <h2>Create a New Reservation</h2>

    <form method="post" action="" id="reservationForm">

      <div id="tables-map-positioner">
        <div id="tables-map">
          {% for table in tables %}
            <button type="button" id="table-{{ table.number }}" class="seats-{{ table.seats }} table">
              Table {{ table.number }} <br> (seats <b>{{ table.seats }}</b>)
            </button>
          {% endfor %}
        </div>

        {{ reservation_form.as_p }}
        {% csrf_token %}
      </div>

      <button type="submit" id="submitButton">Submit</button>

    </form>

    <script type="">
      // Pass reservations to JavaScript
      let reservations = [
          {% for reservation in reservations %}
            {
                'date': '{{ reservation.date|date:"Y-m-d" }}',
                'start_time': '{{ reservation.start_time|time:"H:i" }}',
                'duration': '{{ reservation.duration }}',
                'tables': [
                    {% for table in reservation.tables.all %}
                      '{{ table.id }}',
                    {% endfor %}
                ]
            },
          {% endfor %}
      ];
      // console.log(reservations);
    </script>

    <div id="deleteModal" class="modal">

      <!-- class="modal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" -->
      <div class="modal-content">
        <span class="close">&times;</span>
        <p>Are you sure you want to delete this reservation?</p>
        <a href="#" id="deleteConfirm">Delete</a>
      </div>

    </div>

  {% else %}

    <p>
      To make a new reservation or view/edit an existing reservation, please 
      <a href="{{ signup_url }}">sign up</a> or 
      <a href="{{ login_url }}">log in</a> first.
    </p>

  {% endif %}

{% endblock %}

{% block script %}
  <script src="{% static 'js/table_select.js' %}"></script>
  <script src="{% static 'js/edit_reservation.js' %}"></script>
  <script src="{% static 'js/delete_reservation.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log(reservations);
        let dateInput = document.querySelector('input[name="date"]');
        let timeInput = document.querySelector('input[name="start_time"]');
        let durationInput = document.querySelector('select[name="duration"]');

        function checkAvailability() {
            let selectedDate = dateInput.value;
            let selectedTime = timeInput.value;
            let selectedDuration = durationInput.value;

            // gets user-desired start and ending
            if (selectedDate && selectedTime && selectedDuration) {
                let selectedStart = new Date(`${selectedDate}T${selectedTime}`);
                let selectedEnd = new Date(selectedStart.getTime() + selectedDuration * 60 * 60 * 1000);

                isUnavailable(reservations, selectedStart, selectedEnd);
            };
        }

        // gets existing starts and endings, compares them
        function isUnavailable(reservations, selectedStart, selectedEnd) {
            for (reservation of reservations) {
                let reservationStart = new Date(`${reservation.date}T${reservation.start_time}`);
                let reservationEnd = new Date(reservationStart.getTime() + reservation.duration * 60 * 60 * 1000);

                if (selectedStart < reservationEnd || selectedEnd > reservationStart) {
                    for (table of reservation.tables) {
                        let checkbox = document.querySelector(`input[type="checkbox"][value="${table}"]`);
                        checkbox.disabled = true;
                    };
                };
            };

        }

        dateInput.addEventListener('change', checkAvailability);
        timeInput.addEventListener('change', checkAvailability);
        durationInput.addEventListener('change', checkAvailability);

    });
  </script>
{% endblock %}